{"ast":null,"code":"import { combine, elapsed, generateUUID } from '@datadog/browser-core';\nexport function startVitalCollection(lifeCycle, pageStateHistory) {\n  var vitalStartsByName = new Map();\n  lifeCycle.subscribe(10 /* LifeCycleEventType.SESSION_RENEWED */, function () {\n    // Discard all the vitals that have not been stopped to avoid memory leaks\n    vitalStartsByName.clear();\n  });\n  function isValid(vital) {\n    return !pageStateHistory.wasInPageStateDuringPeriod(\"frozen\" /* PageState.FROZEN */, vital.startClocks.relative, vital.value);\n  }\n  return {\n    startDurationVital: function (vitalStart) {\n      vitalStartsByName.set(vitalStart.name, vitalStart);\n    },\n    stopDurationVital: function (vitalStop) {\n      var vitalStart = vitalStartsByName.get(vitalStop.name);\n      if (!vitalStart) {\n        return;\n      }\n      var vital = buildDurationVital(vitalStart, vitalStop);\n      vitalStartsByName.delete(vital.name);\n      if (isValid(vital)) {\n        lifeCycle.notify(12 /* LifeCycleEventType.RAW_RUM_EVENT_COLLECTED */, processVital(vital, true));\n      }\n    }\n  };\n}\nfunction buildDurationVital(vitalStart, vitalStop) {\n  return {\n    name: vitalStart.name,\n    type: \"duration\" /* VitalType.DURATION */,\n    startClocks: vitalStart.startClocks,\n    value: elapsed(vitalStart.startClocks.timeStamp, vitalStop.stopClocks.timeStamp),\n    context: combine(vitalStart.context, vitalStop.context)\n  };\n}\nfunction processVital(vital, valueComputedBySdk) {\n  var _a;\n  var rawRumEvent = {\n    date: vital.startClocks.timeStamp,\n    vital: {\n      id: generateUUID(),\n      type: vital.type,\n      name: vital.name,\n      custom: (_a = {}, _a[vital.name] = vital.value, _a)\n    },\n    type: \"vital\" /* RumEventType.VITAL */\n  };\n  if (valueComputedBySdk) {\n    rawRumEvent._dd = {\n      vital: {\n        computed_value: true\n      }\n    };\n  }\n  return {\n    rawRumEvent: rawRumEvent,\n    startTime: vital.startClocks.relative,\n    customerContext: vital.context,\n    domainContext: {}\n  };\n}","map":{"version":3,"names":["combine","elapsed","generateUUID","startVitalCollection","lifeCycle","pageStateHistory","vitalStartsByName","Map","subscribe","clear","isValid","vital","wasInPageStateDuringPeriod","startClocks","relative","value","startDurationVital","vitalStart","set","name","stopDurationVital","vitalStop","get","buildDurationVital","delete","notify","processVital","type","timeStamp","stopClocks","context","valueComputedBySdk","rawRumEvent","date","id","custom","_a","_dd","computed_value","startTime","customerContext","domainContext"],"sources":["D:\\edu'\\Spritle\\Spritle\\node_modules\\@datadog\\browser-rum-core\\src\\domain\\vital\\vitalCollection.ts"],"sourcesContent":["import type { ClocksState, Duration, Context } from '@datadog/browser-core'\nimport { combine, elapsed, generateUUID } from '@datadog/browser-core'\nimport type { LifeCycle, RawRumEventCollectedData } from '../lifeCycle'\nimport { LifeCycleEventType } from '../lifeCycle'\nimport type { RawRumVitalEvent } from '../../rawRumEvent.types'\nimport { RumEventType, VitalType } from '../../rawRumEvent.types'\nimport type { PageStateHistory } from '../contexts/pageStateHistory'\nimport { PageState } from '../contexts/pageStateHistory'\n\nexport interface DurationVitalStart {\n  name: string\n  startClocks: ClocksState\n  context?: Context\n}\n\nexport interface DurationVitalStop {\n  name: string\n  stopClocks: ClocksState\n  context?: Context\n}\n\ninterface DurationVital {\n  name: string\n  type: VitalType.DURATION\n  startClocks: ClocksState\n  value: Duration\n  context?: Context\n}\n\nexport function startVitalCollection(lifeCycle: LifeCycle, pageStateHistory: PageStateHistory) {\n  const vitalStartsByName = new Map<string, DurationVitalStart>()\n\n  lifeCycle.subscribe(LifeCycleEventType.SESSION_RENEWED, () => {\n    // Discard all the vitals that have not been stopped to avoid memory leaks\n    vitalStartsByName.clear()\n  })\n\n  function isValid(vital: DurationVital) {\n    return !pageStateHistory.wasInPageStateDuringPeriod(PageState.FROZEN, vital.startClocks.relative, vital.value)\n  }\n\n  return {\n    startDurationVital: (vitalStart: DurationVitalStart) => {\n      vitalStartsByName.set(vitalStart.name, vitalStart)\n    },\n    stopDurationVital: (vitalStop: DurationVitalStop) => {\n      const vitalStart = vitalStartsByName.get(vitalStop.name)\n      if (!vitalStart) {\n        return\n      }\n      const vital = buildDurationVital(vitalStart, vitalStop)\n      vitalStartsByName.delete(vital.name)\n      if (isValid(vital)) {\n        lifeCycle.notify(LifeCycleEventType.RAW_RUM_EVENT_COLLECTED, processVital(vital, true))\n      }\n    },\n  }\n}\n\nfunction buildDurationVital(vitalStart: DurationVitalStart, vitalStop: DurationVitalStop) {\n  return {\n    name: vitalStart.name,\n    type: VitalType.DURATION,\n    startClocks: vitalStart.startClocks,\n    value: elapsed(vitalStart.startClocks.timeStamp, vitalStop.stopClocks.timeStamp),\n    context: combine(vitalStart.context, vitalStop.context),\n  }\n}\n\nfunction processVital(vital: DurationVital, valueComputedBySdk: boolean): RawRumEventCollectedData<RawRumVitalEvent> {\n  const rawRumEvent: RawRumVitalEvent = {\n    date: vital.startClocks.timeStamp,\n    vital: {\n      id: generateUUID(),\n      type: vital.type,\n      name: vital.name,\n      custom: {\n        [vital.name]: vital.value,\n      },\n    },\n    type: RumEventType.VITAL,\n  }\n\n  if (valueComputedBySdk) {\n    rawRumEvent._dd = {\n      vital: {\n        computed_value: true,\n      },\n    }\n  }\n\n  return {\n    rawRumEvent,\n    startTime: vital.startClocks.relative,\n    customerContext: vital.context,\n    domainContext: {},\n  }\n}\n"],"mappings":"AACA,SAASA,OAAO,EAAEC,OAAO,EAAEC,YAAY,QAAQ,uBAAuB;AA4BtE,OAAM,SAAUC,oBAAoBA,CAACC,SAAoB,EAAEC,gBAAkC;EAC3F,IAAMC,iBAAiB,GAAG,IAAIC,GAAG,EAA8B;EAE/DH,SAAS,CAACI,SAAS,8CAAqC;IACtD;IACAF,iBAAiB,CAACG,KAAK,EAAE;EAC3B,CAAC,CAAC;EAEF,SAASC,OAAOA,CAACC,KAAoB;IACnC,OAAO,CAACN,gBAAgB,CAACO,0BAA0B,kCAAmBD,KAAK,CAACE,WAAW,CAACC,QAAQ,EAAEH,KAAK,CAACI,KAAK,CAAC;EAChH;EAEA,OAAO;IACLC,kBAAkB,EAAE,SAAAA,CAACC,UAA8B;MACjDX,iBAAiB,CAACY,GAAG,CAACD,UAAU,CAACE,IAAI,EAAEF,UAAU,CAAC;IACpD,CAAC;IACDG,iBAAiB,EAAE,SAAAA,CAACC,SAA4B;MAC9C,IAAMJ,UAAU,GAAGX,iBAAiB,CAACgB,GAAG,CAACD,SAAS,CAACF,IAAI,CAAC;MACxD,IAAI,CAACF,UAAU,EAAE;QACf;MACF;MACA,IAAMN,KAAK,GAAGY,kBAAkB,CAACN,UAAU,EAAEI,SAAS,CAAC;MACvDf,iBAAiB,CAACkB,MAAM,CAACb,KAAK,CAACQ,IAAI,CAAC;MACpC,IAAIT,OAAO,CAACC,KAAK,CAAC,EAAE;QAClBP,SAAS,CAACqB,MAAM,sDAA6CC,YAAY,CAACf,KAAK,EAAE,IAAI,CAAC,CAAC;MACzF;IACF;GACD;AACH;AAEA,SAASY,kBAAkBA,CAACN,UAA8B,EAAEI,SAA4B;EACtF,OAAO;IACLF,IAAI,EAAEF,UAAU,CAACE,IAAI;IACrBQ,IAAI;IACJd,WAAW,EAAEI,UAAU,CAACJ,WAAW;IACnCE,KAAK,EAAEd,OAAO,CAACgB,UAAU,CAACJ,WAAW,CAACe,SAAS,EAAEP,SAAS,CAACQ,UAAU,CAACD,SAAS,CAAC;IAChFE,OAAO,EAAE9B,OAAO,CAACiB,UAAU,CAACa,OAAO,EAAET,SAAS,CAACS,OAAO;GACvD;AACH;AAEA,SAASJ,YAAYA,CAACf,KAAoB,EAAEoB,kBAA2B;;EACrE,IAAMC,WAAW,GAAqB;IACpCC,IAAI,EAAEtB,KAAK,CAACE,WAAW,CAACe,SAAS;IACjCjB,KAAK,EAAE;MACLuB,EAAE,EAAEhC,YAAY,EAAE;MAClByB,IAAI,EAAEhB,KAAK,CAACgB,IAAI;MAChBR,IAAI,EAAER,KAAK,CAACQ,IAAI;MAChBgB,MAAM,GAAAC,EAAA,OACJA,EAAA,CAACzB,KAAK,CAACQ,IAAI,IAAGR,KAAK,CAACI,KAAK,E;KAE5B;IACDY,IAAI;GACL;EAED,IAAII,kBAAkB,EAAE;IACtBC,WAAW,CAACK,GAAG,GAAG;MAChB1B,KAAK,EAAE;QACL2B,cAAc,EAAE;;KAEnB;EACH;EAEA,OAAO;IACLN,WAAW,EAAAA,WAAA;IACXO,SAAS,EAAE5B,KAAK,CAACE,WAAW,CAACC,QAAQ;IACrC0B,eAAe,EAAE7B,KAAK,CAACmB,OAAO;IAC9BW,aAAa,EAAE;GAChB;AACH","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}
{"ast":null,"code":"import { isEmptyObject, assign, ErrorSource, generateUUID, computeRawError, computeStackTrace, Observable, trackRuntimeError } from '@datadog/browser-core';\nimport { trackConsoleError } from './trackConsoleError';\nimport { trackReportError } from './trackReportError';\nexport function startErrorCollection(lifeCycle, configuration, pageStateHistory, featureFlagContexts) {\n  var errorObservable = new Observable();\n  trackConsoleError(errorObservable);\n  trackRuntimeError(errorObservable);\n  trackReportError(configuration, errorObservable);\n  errorObservable.subscribe(function (error) {\n    return lifeCycle.notify(14 /* LifeCycleEventType.RAW_ERROR_COLLECTED */, {\n      error: error\n    });\n  });\n  return doStartErrorCollection(lifeCycle, pageStateHistory, featureFlagContexts);\n}\nexport function doStartErrorCollection(lifeCycle, pageStateHistory, featureFlagContexts) {\n  lifeCycle.subscribe(14 /* LifeCycleEventType.RAW_ERROR_COLLECTED */, function (_a) {\n    var error = _a.error,\n      customerContext = _a.customerContext,\n      savedCommonContext = _a.savedCommonContext;\n    lifeCycle.notify(12 /* LifeCycleEventType.RAW_RUM_EVENT_COLLECTED */, assign({\n      customerContext: customerContext,\n      savedCommonContext: savedCommonContext\n    }, processError(error, pageStateHistory, featureFlagContexts)));\n  });\n  return {\n    addError: function (_a, savedCommonContext) {\n      var error = _a.error,\n        handlingStack = _a.handlingStack,\n        startClocks = _a.startClocks,\n        customerContext = _a.context;\n      var stackTrace = error instanceof Error ? computeStackTrace(error) : undefined;\n      var rawError = computeRawError({\n        stackTrace: stackTrace,\n        originalError: error,\n        handlingStack: handlingStack,\n        startClocks: startClocks,\n        nonErrorPrefix: \"Provided\" /* NonErrorPrefix.PROVIDED */,\n        source: ErrorSource.CUSTOM,\n        handling: \"handled\" /* ErrorHandling.HANDLED */\n      });\n      lifeCycle.notify(14 /* LifeCycleEventType.RAW_ERROR_COLLECTED */, {\n        customerContext: customerContext,\n        savedCommonContext: savedCommonContext,\n        error: rawError\n      });\n    }\n  };\n}\nfunction processError(error, pageStateHistory, featureFlagContexts) {\n  var rawRumEvent = {\n    date: error.startClocks.timeStamp,\n    error: {\n      id: generateUUID(),\n      message: error.message,\n      source: error.source,\n      stack: error.stack,\n      handling_stack: error.handlingStack,\n      type: error.type,\n      handling: error.handling,\n      causes: error.causes,\n      source_type: 'browser',\n      fingerprint: error.fingerprint,\n      csp: error.csp\n    },\n    type: \"error\" /* RumEventType.ERROR */,\n    view: {\n      in_foreground: pageStateHistory.wasInPageStateAt(\"active\" /* PageState.ACTIVE */, error.startClocks.relative)\n    }\n  };\n  var featureFlagContext = featureFlagContexts.findFeatureFlagEvaluations(error.startClocks.relative);\n  if (featureFlagContext && !isEmptyObject(featureFlagContext)) {\n    rawRumEvent.feature_flags = featureFlagContext;\n  }\n  return {\n    rawRumEvent: rawRumEvent,\n    startTime: error.startClocks.relative,\n    domainContext: {\n      error: error.originalError\n    }\n  };\n}","map":{"version":3,"names":["isEmptyObject","assign","ErrorSource","generateUUID","computeRawError","computeStackTrace","Observable","trackRuntimeError","trackConsoleError","trackReportError","startErrorCollection","lifeCycle","configuration","pageStateHistory","featureFlagContexts","errorObservable","subscribe","error","notify","doStartErrorCollection","_a","customerContext","savedCommonContext","processError","addError","handlingStack","startClocks","context","stackTrace","Error","undefined","rawError","originalError","nonErrorPrefix","source","CUSTOM","handling","rawRumEvent","date","timeStamp","id","message","stack","handling_stack","type","causes","source_type","fingerprint","csp","view","in_foreground","wasInPageStateAt","relative","featureFlagContext","findFeatureFlagEvaluations","feature_flags","startTime","domainContext"],"sources":["D:\\edu'\\Spritle\\spritle\\node_modules\\@datadog\\browser-rum-core\\src\\domain\\error\\errorCollection.ts"],"sourcesContent":["import type { Context, RawError, ClocksState } from '@datadog/browser-core'\nimport {\n  isEmptyObject,\n  assign,\n  ErrorSource,\n  generateUUID,\n  computeRawError,\n  ErrorHandling,\n  computeStackTrace,\n  Observable,\n  trackRuntimeError,\n  NonErrorPrefix,\n} from '@datadog/browser-core'\nimport type { RumConfiguration } from '../configuration'\nimport type { RawRumErrorEvent } from '../../rawRumEvent.types'\nimport { RumEventType } from '../../rawRumEvent.types'\nimport type { LifeCycle, RawRumEventCollectedData } from '../lifeCycle'\nimport { LifeCycleEventType } from '../lifeCycle'\nimport type { FeatureFlagContexts } from '../contexts/featureFlagContext'\nimport type { CommonContext } from '../contexts/commonContext'\nimport type { PageStateHistory } from '../contexts/pageStateHistory'\nimport { PageState } from '../contexts/pageStateHistory'\nimport { trackConsoleError } from './trackConsoleError'\nimport { trackReportError } from './trackReportError'\n\nexport interface ProvidedError {\n  startClocks: ClocksState\n  error: unknown\n  context?: Context\n  handlingStack: string\n}\n\nexport function startErrorCollection(\n  lifeCycle: LifeCycle,\n  configuration: RumConfiguration,\n  pageStateHistory: PageStateHistory,\n  featureFlagContexts: FeatureFlagContexts\n) {\n  const errorObservable = new Observable<RawError>()\n\n  trackConsoleError(errorObservable)\n  trackRuntimeError(errorObservable)\n  trackReportError(configuration, errorObservable)\n\n  errorObservable.subscribe((error) => lifeCycle.notify(LifeCycleEventType.RAW_ERROR_COLLECTED, { error }))\n\n  return doStartErrorCollection(lifeCycle, pageStateHistory, featureFlagContexts)\n}\n\nexport function doStartErrorCollection(\n  lifeCycle: LifeCycle,\n  pageStateHistory: PageStateHistory,\n  featureFlagContexts: FeatureFlagContexts\n) {\n  lifeCycle.subscribe(LifeCycleEventType.RAW_ERROR_COLLECTED, ({ error, customerContext, savedCommonContext }) => {\n    lifeCycle.notify(\n      LifeCycleEventType.RAW_RUM_EVENT_COLLECTED,\n      assign(\n        {\n          customerContext,\n          savedCommonContext,\n        },\n        processError(error, pageStateHistory, featureFlagContexts)\n      )\n    )\n  })\n\n  return {\n    addError: (\n      { error, handlingStack, startClocks, context: customerContext }: ProvidedError,\n      savedCommonContext?: CommonContext\n    ) => {\n      const stackTrace = error instanceof Error ? computeStackTrace(error) : undefined\n      const rawError = computeRawError({\n        stackTrace,\n        originalError: error,\n        handlingStack,\n        startClocks,\n        nonErrorPrefix: NonErrorPrefix.PROVIDED,\n        source: ErrorSource.CUSTOM,\n        handling: ErrorHandling.HANDLED,\n      })\n\n      lifeCycle.notify(LifeCycleEventType.RAW_ERROR_COLLECTED, {\n        customerContext,\n        savedCommonContext,\n        error: rawError,\n      })\n    },\n  }\n}\n\nfunction processError(\n  error: RawError,\n  pageStateHistory: PageStateHistory,\n  featureFlagContexts: FeatureFlagContexts\n): RawRumEventCollectedData<RawRumErrorEvent> {\n  const rawRumEvent: RawRumErrorEvent = {\n    date: error.startClocks.timeStamp,\n    error: {\n      id: generateUUID(),\n      message: error.message,\n      source: error.source,\n      stack: error.stack,\n      handling_stack: error.handlingStack,\n      type: error.type,\n      handling: error.handling,\n      causes: error.causes,\n      source_type: 'browser',\n      fingerprint: error.fingerprint,\n      csp: error.csp,\n    },\n    type: RumEventType.ERROR as const,\n    view: { in_foreground: pageStateHistory.wasInPageStateAt(PageState.ACTIVE, error.startClocks.relative) },\n  }\n\n  const featureFlagContext = featureFlagContexts.findFeatureFlagEvaluations(error.startClocks.relative)\n  if (featureFlagContext && !isEmptyObject(featureFlagContext)) {\n    rawRumEvent.feature_flags = featureFlagContext\n  }\n\n  return {\n    rawRumEvent,\n    startTime: error.startClocks.relative,\n    domainContext: {\n      error: error.originalError,\n    },\n  }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}
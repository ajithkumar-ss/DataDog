{"ast":null,"code":"import { addEventListener, DOM_EVENT } from '../../browser/addEventListener';\nimport { combine } from '../../tools/mergeInto';\nvar CONTEXT_STORE_KEY_PREFIX = '_dd_c';\nvar storageListeners = [];\nexport function storeContextManager(configuration, contextManager, productKey, customerDataType) {\n  var storageKey = buildStorageKey(productKey, customerDataType);\n  storageListeners.push(addEventListener(configuration, window, DOM_EVENT.STORAGE, function (_a) {\n    var key = _a.key;\n    if (storageKey === key) {\n      synchronizeWithStorage();\n    }\n  }));\n  contextManager.changeObservable.subscribe(dumpToStorage);\n  contextManager.setContext(combine(getFromStorage(), contextManager.getContext()));\n  function synchronizeWithStorage() {\n    contextManager.setContext(getFromStorage());\n  }\n  function dumpToStorage() {\n    localStorage.setItem(storageKey, JSON.stringify(contextManager.getContext()));\n  }\n  function getFromStorage() {\n    var rawContext = localStorage.getItem(storageKey);\n    return rawContext !== null ? JSON.parse(rawContext) : {};\n  }\n}\nexport function buildStorageKey(productKey, customerDataType) {\n  return \"\".concat(CONTEXT_STORE_KEY_PREFIX, \"_\").concat(productKey, \"_\").concat(customerDataType);\n}\nexport function removeStorageListeners() {\n  storageListeners.map(function (listener) {\n    return listener.stop();\n  });\n}","map":{"version":3,"names":["addEventListener","DOM_EVENT","combine","CONTEXT_STORE_KEY_PREFIX","storageListeners","storeContextManager","configuration","contextManager","productKey","customerDataType","storageKey","buildStorageKey","push","window","STORAGE","_a","key","synchronizeWithStorage","changeObservable","subscribe","dumpToStorage","setContext","getFromStorage","getContext","localStorage","setItem","JSON","stringify","rawContext","getItem","parse","concat","removeStorageListeners","map","listener","stop"],"sources":["D:\\edu'\\Spritle\\Spritle\\node_modules\\@datadog\\browser-core\\src\\domain\\context\\storeContextManager.ts"],"sourcesContent":["import { addEventListener, DOM_EVENT } from '../../browser/addEventListener'\nimport type { Context } from '../../tools/serialisation/context'\nimport type { Configuration } from '../configuration'\nimport { combine } from '../../tools/mergeInto'\nimport type { ContextManager } from './contextManager'\nimport type { CustomerDataType } from './contextConstants'\n\nconst CONTEXT_STORE_KEY_PREFIX = '_dd_c'\n\nconst storageListeners: Array<{ stop: () => void }> = []\n\nexport function storeContextManager(\n  configuration: Configuration,\n  contextManager: ContextManager,\n  productKey: string,\n  customerDataType: CustomerDataType\n) {\n  const storageKey = buildStorageKey(productKey, customerDataType)\n\n  storageListeners.push(\n    addEventListener(configuration, window, DOM_EVENT.STORAGE, ({ key }) => {\n      if (storageKey === key) {\n        synchronizeWithStorage()\n      }\n    })\n  )\n  contextManager.changeObservable.subscribe(dumpToStorage)\n\n  contextManager.setContext(combine(getFromStorage(), contextManager.getContext()))\n\n  function synchronizeWithStorage() {\n    contextManager.setContext(getFromStorage())\n  }\n\n  function dumpToStorage() {\n    localStorage.setItem(storageKey, JSON.stringify(contextManager.getContext()))\n  }\n\n  function getFromStorage() {\n    const rawContext = localStorage.getItem(storageKey)\n    return rawContext !== null ? (JSON.parse(rawContext) as Context) : {}\n  }\n}\n\nexport function buildStorageKey(productKey: string, customerDataType: CustomerDataType) {\n  return `${CONTEXT_STORE_KEY_PREFIX}_${productKey}_${customerDataType}`\n}\n\nexport function removeStorageListeners() {\n  storageListeners.map((listener) => listener.stop())\n}\n"],"mappings":"AAAA,SAASA,gBAAgB,EAAEC,SAAS,QAAQ,gCAAgC;AAG5E,SAASC,OAAO,QAAQ,uBAAuB;AAI/C,IAAMC,wBAAwB,GAAG,OAAO;AAExC,IAAMC,gBAAgB,GAAgC,EAAE;AAExD,OAAM,SAAUC,mBAAmBA,CACjCC,aAA4B,EAC5BC,cAA8B,EAC9BC,UAAkB,EAClBC,gBAAkC;EAElC,IAAMC,UAAU,GAAGC,eAAe,CAACH,UAAU,EAAEC,gBAAgB,CAAC;EAEhEL,gBAAgB,CAACQ,IAAI,CACnBZ,gBAAgB,CAACM,aAAa,EAAEO,MAAM,EAAEZ,SAAS,CAACa,OAAO,EAAE,UAACC,EAAO;QAALC,GAAG,GAAAD,EAAA,CAAAC,GAAA;IAC/D,IAAIN,UAAU,KAAKM,GAAG,EAAE;MACtBC,sBAAsB,EAAE;IAC1B;EACF,CAAC,CAAC,CACH;EACDV,cAAc,CAACW,gBAAgB,CAACC,SAAS,CAACC,aAAa,CAAC;EAExDb,cAAc,CAACc,UAAU,CAACnB,OAAO,CAACoB,cAAc,EAAE,EAAEf,cAAc,CAACgB,UAAU,EAAE,CAAC,CAAC;EAEjF,SAASN,sBAAsBA,CAAA;IAC7BV,cAAc,CAACc,UAAU,CAACC,cAAc,EAAE,CAAC;EAC7C;EAEA,SAASF,aAAaA,CAAA;IACpBI,YAAY,CAACC,OAAO,CAACf,UAAU,EAAEgB,IAAI,CAACC,SAAS,CAACpB,cAAc,CAACgB,UAAU,EAAE,CAAC,CAAC;EAC/E;EAEA,SAASD,cAAcA,CAAA;IACrB,IAAMM,UAAU,GAAGJ,YAAY,CAACK,OAAO,CAACnB,UAAU,CAAC;IACnD,OAAOkB,UAAU,KAAK,IAAI,GAAIF,IAAI,CAACI,KAAK,CAACF,UAAU,CAAa,GAAG,EAAE;EACvE;AACF;AAEA,OAAM,SAAUjB,eAAeA,CAACH,UAAkB,EAAEC,gBAAkC;EACpF,OAAO,GAAAsB,MAAA,CAAG5B,wBAAwB,OAAA4B,MAAA,CAAIvB,UAAU,OAAAuB,MAAA,CAAItB,gBAAgB,CAAE;AACxE;AAEA,OAAM,SAAUuB,sBAAsBA,CAAA;EACpC5B,gBAAgB,CAAC6B,GAAG,CAAC,UAACC,QAAQ;IAAK,OAAAA,QAAQ,CAACC,IAAI,EAAE;EAAf,CAAe,CAAC;AACrD","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}
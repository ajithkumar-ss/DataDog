{"ast":null,"code":"import { SESSION_TIME_OUT_DELAY, relativeNow, ValueHistory } from '@datadog/browser-core';\n/**\n * We want to attach to an event:\n * - the url corresponding to its start\n * - the referrer corresponding to the previous view url (or document referrer for initial view)\n */\nexport var URL_CONTEXT_TIME_OUT_DELAY = SESSION_TIME_OUT_DELAY;\nexport function startUrlContexts(lifeCycle, locationChangeObservable, location) {\n  var urlContextHistory = new ValueHistory(URL_CONTEXT_TIME_OUT_DELAY);\n  var previousViewUrl;\n  lifeCycle.subscribe(2 /* LifeCycleEventType.BEFORE_VIEW_CREATED */, function (_a) {\n    var startClocks = _a.startClocks;\n    var viewUrl = location.href;\n    urlContextHistory.add(buildUrlContext({\n      url: viewUrl,\n      referrer: !previousViewUrl ? document.referrer : previousViewUrl\n    }), startClocks.relative);\n    previousViewUrl = viewUrl;\n  });\n  lifeCycle.subscribe(6 /* LifeCycleEventType.AFTER_VIEW_ENDED */, function (_a) {\n    var endClocks = _a.endClocks;\n    urlContextHistory.closeActive(endClocks.relative);\n  });\n  var locationChangeSubscription = locationChangeObservable.subscribe(function (_a) {\n    var newLocation = _a.newLocation;\n    var current = urlContextHistory.find();\n    if (current) {\n      var changeTime = relativeNow();\n      urlContextHistory.closeActive(changeTime);\n      urlContextHistory.add(buildUrlContext({\n        url: newLocation.href,\n        referrer: current.referrer\n      }), changeTime);\n    }\n  });\n  function buildUrlContext(_a) {\n    var url = _a.url,\n      referrer = _a.referrer;\n    return {\n      url: url,\n      referrer: referrer\n    };\n  }\n  return {\n    findUrl: function (startTime) {\n      return urlContextHistory.find(startTime);\n    },\n    stop: function () {\n      locationChangeSubscription.unsubscribe();\n      urlContextHistory.stop();\n    }\n  };\n}","map":{"version":3,"names":["SESSION_TIME_OUT_DELAY","relativeNow","ValueHistory","URL_CONTEXT_TIME_OUT_DELAY","startUrlContexts","lifeCycle","locationChangeObservable","location","urlContextHistory","previousViewUrl","subscribe","_a","startClocks","viewUrl","href","add","buildUrlContext","url","referrer","document","relative","endClocks","closeActive","locationChangeSubscription","newLocation","current","find","changeTime","findUrl","startTime","stop","unsubscribe"],"sources":["D:\\edu'\\Spritle\\spritle\\node_modules\\@datadog\\browser-rum-core\\src\\domain\\contexts\\urlContexts.ts"],"sourcesContent":["import type { RelativeTime, Observable } from '@datadog/browser-core'\nimport { SESSION_TIME_OUT_DELAY, relativeNow, ValueHistory } from '@datadog/browser-core'\nimport type { LocationChange } from '../../browser/locationChangeObservable'\nimport type { LifeCycle } from '../lifeCycle'\nimport { LifeCycleEventType } from '../lifeCycle'\n\n/**\n * We want to attach to an event:\n * - the url corresponding to its start\n * - the referrer corresponding to the previous view url (or document referrer for initial view)\n */\n\nexport const URL_CONTEXT_TIME_OUT_DELAY = SESSION_TIME_OUT_DELAY\n\nexport interface UrlContext {\n  url: string\n  referrer: string\n}\n\nexport interface UrlContexts {\n  findUrl: (startTime?: RelativeTime) => UrlContext | undefined\n  stop: () => void\n}\n\nexport function startUrlContexts(\n  lifeCycle: LifeCycle,\n  locationChangeObservable: Observable<LocationChange>,\n  location: Location\n) {\n  const urlContextHistory = new ValueHistory<UrlContext>(URL_CONTEXT_TIME_OUT_DELAY)\n\n  let previousViewUrl: string | undefined\n\n  lifeCycle.subscribe(LifeCycleEventType.BEFORE_VIEW_CREATED, ({ startClocks }) => {\n    const viewUrl = location.href\n    urlContextHistory.add(\n      buildUrlContext({\n        url: viewUrl,\n        referrer: !previousViewUrl ? document.referrer : previousViewUrl,\n      }),\n      startClocks.relative\n    )\n    previousViewUrl = viewUrl\n  })\n\n  lifeCycle.subscribe(LifeCycleEventType.AFTER_VIEW_ENDED, ({ endClocks }) => {\n    urlContextHistory.closeActive(endClocks.relative)\n  })\n\n  const locationChangeSubscription = locationChangeObservable.subscribe(({ newLocation }) => {\n    const current = urlContextHistory.find()\n    if (current) {\n      const changeTime = relativeNow()\n      urlContextHistory.closeActive(changeTime)\n      urlContextHistory.add(\n        buildUrlContext({\n          url: newLocation.href,\n          referrer: current.referrer,\n        }),\n        changeTime\n      )\n    }\n  })\n\n  function buildUrlContext({ url, referrer }: { url: string; referrer: string }) {\n    return {\n      url,\n      referrer,\n    }\n  }\n\n  return {\n    findUrl: (startTime?: RelativeTime) => urlContextHistory.find(startTime),\n    stop: () => {\n      locationChangeSubscription.unsubscribe()\n      urlContextHistory.stop()\n    },\n  }\n}\n"],"mappings":"AACA,SAASA,sBAAsB,EAAEC,WAAW,EAAEC,YAAY,QAAQ,uBAAuB;AAKzF;;;;;AAMA,OAAO,IAAMC,0BAA0B,GAAGH,sBAAsB;AAYhE,OAAM,SAAUI,gBAAgBA,CAC9BC,SAAoB,EACpBC,wBAAoD,EACpDC,QAAkB;EAElB,IAAMC,iBAAiB,GAAG,IAAIN,YAAY,CAAaC,0BAA0B,CAAC;EAElF,IAAIM,eAAmC;EAEvCJ,SAAS,CAACK,SAAS,iDAAyC,UAACC,EAAe;QAAbC,WAAW,GAAAD,EAAA,CAAAC,WAAA;IACxE,IAAMC,OAAO,GAAGN,QAAQ,CAACO,IAAI;IAC7BN,iBAAiB,CAACO,GAAG,CACnBC,eAAe,CAAC;MACdC,GAAG,EAAEJ,OAAO;MACZK,QAAQ,EAAE,CAACT,eAAe,GAAGU,QAAQ,CAACD,QAAQ,GAAGT;KAClD,CAAC,EACFG,WAAW,CAACQ,QAAQ,CACrB;IACDX,eAAe,GAAGI,OAAO;EAC3B,CAAC,CAAC;EAEFR,SAAS,CAACK,SAAS,8CAAsC,UAACC,EAAa;QAAXU,SAAS,GAAAV,EAAA,CAAAU,SAAA;IACnEb,iBAAiB,CAACc,WAAW,CAACD,SAAS,CAACD,QAAQ,CAAC;EACnD,CAAC,CAAC;EAEF,IAAMG,0BAA0B,GAAGjB,wBAAwB,CAACI,SAAS,CAAC,UAACC,EAAe;QAAba,WAAW,GAAAb,EAAA,CAAAa,WAAA;IAClF,IAAMC,OAAO,GAAGjB,iBAAiB,CAACkB,IAAI,EAAE;IACxC,IAAID,OAAO,EAAE;MACX,IAAME,UAAU,GAAG1B,WAAW,EAAE;MAChCO,iBAAiB,CAACc,WAAW,CAACK,UAAU,CAAC;MACzCnB,iBAAiB,CAACO,GAAG,CACnBC,eAAe,CAAC;QACdC,GAAG,EAAEO,WAAW,CAACV,IAAI;QACrBI,QAAQ,EAAEO,OAAO,CAACP;OACnB,CAAC,EACFS,UAAU,CACX;IACH;EACF,CAAC,CAAC;EAEF,SAASX,eAAeA,CAACL,EAAoD;QAAlDM,GAAG,GAAAN,EAAA,CAAAM,GAAA;MAAEC,QAAQ,GAAAP,EAAA,CAAAO,QAAA;IACtC,OAAO;MACLD,GAAG,EAAAA,GAAA;MACHC,QAAQ,EAAAA;KACT;EACH;EAEA,OAAO;IACLU,OAAO,EAAE,SAAAA,CAACC,SAAwB;MAAK,OAAArB,iBAAiB,CAACkB,IAAI,CAACG,SAAS,CAAC;IAAjC,CAAiC;IACxEC,IAAI,EAAE,SAAAA,CAAA;MACJP,0BAA0B,CAACQ,WAAW,EAAE;MACxCvB,iBAAiB,CAACsB,IAAI,EAAE;IAC1B;GACD;AACH","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}
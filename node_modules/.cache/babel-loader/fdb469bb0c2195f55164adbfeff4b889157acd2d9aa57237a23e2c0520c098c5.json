{"ast":null,"code":"import { isEmptyObject, mapValues, toServerDuration, isNumber } from '@datadog/browser-core';\nimport { trackViews } from './trackViews';\nexport function startViewCollection(lifeCycle, configuration, location, domMutationObservable, locationChangeObservable, featureFlagContexts, pageStateHistory, recorderApi, initialViewOptions) {\n  lifeCycle.subscribe(4 /* LifeCycleEventType.VIEW_UPDATED */, function (view) {\n    return lifeCycle.notify(12 /* LifeCycleEventType.RAW_RUM_EVENT_COLLECTED */, processViewUpdate(view, configuration, featureFlagContexts, recorderApi, pageStateHistory));\n  });\n  return trackViews(location, lifeCycle, domMutationObservable, configuration, locationChangeObservable, !configuration.trackViewsManually, initialViewOptions);\n}\nfunction processViewUpdate(view, configuration, featureFlagContexts, recorderApi, pageStateHistory) {\n  var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o, _p;\n  var replayStats = recorderApi.getReplayStats(view.id);\n  var featureFlagContext = featureFlagContexts.findFeatureFlagEvaluations(view.startClocks.relative);\n  var pageStates = pageStateHistory.findAll(view.startClocks.relative, view.duration);\n  var viewEvent = {\n    _dd: {\n      document_version: view.documentVersion,\n      replay_stats: replayStats,\n      page_states: pageStates,\n      configuration: {\n        start_session_replay_recording_manually: configuration.startSessionReplayRecordingManually\n      }\n    },\n    date: view.startClocks.timeStamp,\n    type: \"view\" /* RumEventType.VIEW */,\n    view: {\n      action: {\n        count: view.eventCounts.actionCount\n      },\n      frustration: {\n        count: view.eventCounts.frustrationCount\n      },\n      cumulative_layout_shift: (_a = view.commonViewMetrics.cumulativeLayoutShift) === null || _a === void 0 ? void 0 : _a.value,\n      cumulative_layout_shift_target_selector: (_b = view.commonViewMetrics.cumulativeLayoutShift) === null || _b === void 0 ? void 0 : _b.targetSelector,\n      first_byte: toServerDuration((_c = view.initialViewMetrics.navigationTimings) === null || _c === void 0 ? void 0 : _c.firstByte),\n      dom_complete: toServerDuration((_d = view.initialViewMetrics.navigationTimings) === null || _d === void 0 ? void 0 : _d.domComplete),\n      dom_content_loaded: toServerDuration((_e = view.initialViewMetrics.navigationTimings) === null || _e === void 0 ? void 0 : _e.domContentLoaded),\n      dom_interactive: toServerDuration((_f = view.initialViewMetrics.navigationTimings) === null || _f === void 0 ? void 0 : _f.domInteractive),\n      error: {\n        count: view.eventCounts.errorCount\n      },\n      first_contentful_paint: toServerDuration(view.initialViewMetrics.firstContentfulPaint),\n      first_input_delay: toServerDuration((_g = view.initialViewMetrics.firstInput) === null || _g === void 0 ? void 0 : _g.delay),\n      first_input_time: toServerDuration((_h = view.initialViewMetrics.firstInput) === null || _h === void 0 ? void 0 : _h.time),\n      first_input_target_selector: (_j = view.initialViewMetrics.firstInput) === null || _j === void 0 ? void 0 : _j.targetSelector,\n      interaction_to_next_paint: toServerDuration((_k = view.commonViewMetrics.interactionToNextPaint) === null || _k === void 0 ? void 0 : _k.value),\n      interaction_to_next_paint_target_selector: (_l = view.commonViewMetrics.interactionToNextPaint) === null || _l === void 0 ? void 0 : _l.targetSelector,\n      is_active: view.isActive,\n      name: view.name,\n      largest_contentful_paint: toServerDuration((_m = view.initialViewMetrics.largestContentfulPaint) === null || _m === void 0 ? void 0 : _m.value),\n      largest_contentful_paint_target_selector: (_o = view.initialViewMetrics.largestContentfulPaint) === null || _o === void 0 ? void 0 : _o.targetSelector,\n      load_event: toServerDuration((_p = view.initialViewMetrics.navigationTimings) === null || _p === void 0 ? void 0 : _p.loadEvent),\n      loading_time: discardNegativeDuration(toServerDuration(view.commonViewMetrics.loadingTime)),\n      loading_type: view.loadingType,\n      long_task: {\n        count: view.eventCounts.longTaskCount\n      },\n      resource: {\n        count: view.eventCounts.resourceCount\n      },\n      time_spent: toServerDuration(view.duration)\n    },\n    feature_flags: featureFlagContext && !isEmptyObject(featureFlagContext) ? featureFlagContext : undefined,\n    display: view.commonViewMetrics.scroll ? {\n      scroll: {\n        max_depth: view.commonViewMetrics.scroll.maxDepth,\n        max_depth_scroll_top: view.commonViewMetrics.scroll.maxDepthScrollTop,\n        max_scroll_height: view.commonViewMetrics.scroll.maxScrollHeight,\n        max_scroll_height_time: toServerDuration(view.commonViewMetrics.scroll.maxScrollHeightTime)\n      }\n    } : undefined,\n    session: {\n      has_replay: replayStats ? true : undefined,\n      is_active: view.sessionIsActive ? undefined : false\n    },\n    privacy: {\n      replay_level: configuration.defaultPrivacyLevel\n    }\n  };\n  if (!isEmptyObject(view.customTimings)) {\n    viewEvent.view.custom_timings = mapValues(view.customTimings, toServerDuration);\n  }\n  return {\n    rawRumEvent: viewEvent,\n    startTime: view.startClocks.relative,\n    domainContext: {\n      location: view.location\n    }\n  };\n}\nfunction discardNegativeDuration(duration) {\n  return isNumber(duration) && duration < 0 ? undefined : duration;\n}","map":{"version":3,"names":["isEmptyObject","mapValues","toServerDuration","isNumber","trackViews","startViewCollection","lifeCycle","configuration","location","domMutationObservable","locationChangeObservable","featureFlagContexts","pageStateHistory","recorderApi","initialViewOptions","subscribe","view","notify","processViewUpdate","trackViewsManually","replayStats","getReplayStats","id","featureFlagContext","findFeatureFlagEvaluations","startClocks","relative","pageStates","findAll","duration","viewEvent","_dd","document_version","documentVersion","replay_stats","page_states","start_session_replay_recording_manually","startSessionReplayRecordingManually","date","timeStamp","type","action","count","eventCounts","actionCount","frustration","frustrationCount","cumulative_layout_shift","_a","commonViewMetrics","cumulativeLayoutShift","value","cumulative_layout_shift_target_selector","_b","targetSelector","first_byte","_c","initialViewMetrics","navigationTimings","firstByte","dom_complete","_d","domComplete","dom_content_loaded","_e","domContentLoaded","dom_interactive","_f","domInteractive","error","errorCount","first_contentful_paint","firstContentfulPaint","first_input_delay","_g","firstInput","delay","first_input_time","_h","time","first_input_target_selector","_j","interaction_to_next_paint","_k","interactionToNextPaint","interaction_to_next_paint_target_selector","_l","is_active","isActive","name","largest_contentful_paint","_m","largestContentfulPaint","largest_contentful_paint_target_selector","_o","load_event","_p","loadEvent","loading_time","discardNegativeDuration","loadingTime","loading_type","loadingType","long_task","longTaskCount","resource","resourceCount","time_spent","feature_flags","undefined","display","scroll","max_depth","maxDepth","max_depth_scroll_top","maxDepthScrollTop","max_scroll_height","maxScrollHeight","max_scroll_height_time","maxScrollHeightTime","session","has_replay","sessionIsActive","privacy","replay_level","defaultPrivacyLevel","customTimings","custom_timings","rawRumEvent","startTime","domainContext"],"sources":["D:\\edu'\\Spritle\\spritle\\node_modules\\@datadog\\browser-rum-core\\src\\domain\\view\\viewCollection.ts"],"sourcesContent":["import type { Duration, ServerDuration, Observable } from '@datadog/browser-core'\nimport { isEmptyObject, mapValues, toServerDuration, isNumber } from '@datadog/browser-core'\nimport type { RecorderApi } from '../../boot/rumPublicApi'\nimport type { RawRumViewEvent } from '../../rawRumEvent.types'\nimport { RumEventType } from '../../rawRumEvent.types'\nimport type { LifeCycle, RawRumEventCollectedData } from '../lifeCycle'\nimport { LifeCycleEventType } from '../lifeCycle'\nimport type { LocationChange } from '../../browser/locationChangeObservable'\nimport type { RumConfiguration } from '../configuration'\nimport type { FeatureFlagContexts } from '../contexts/featureFlagContext'\nimport type { PageStateHistory } from '../contexts/pageStateHistory'\nimport type { ViewEvent, ViewOptions } from './trackViews'\nimport { trackViews } from './trackViews'\n\nexport function startViewCollection(\n  lifeCycle: LifeCycle,\n  configuration: RumConfiguration,\n  location: Location,\n  domMutationObservable: Observable<void>,\n  locationChangeObservable: Observable<LocationChange>,\n  featureFlagContexts: FeatureFlagContexts,\n  pageStateHistory: PageStateHistory,\n  recorderApi: RecorderApi,\n  initialViewOptions?: ViewOptions\n) {\n  lifeCycle.subscribe(LifeCycleEventType.VIEW_UPDATED, (view) =>\n    lifeCycle.notify(\n      LifeCycleEventType.RAW_RUM_EVENT_COLLECTED,\n      processViewUpdate(view, configuration, featureFlagContexts, recorderApi, pageStateHistory)\n    )\n  )\n  return trackViews(\n    location,\n    lifeCycle,\n    domMutationObservable,\n    configuration,\n    locationChangeObservable,\n    !configuration.trackViewsManually,\n    initialViewOptions\n  )\n}\n\nfunction processViewUpdate(\n  view: ViewEvent,\n  configuration: RumConfiguration,\n  featureFlagContexts: FeatureFlagContexts,\n  recorderApi: RecorderApi,\n  pageStateHistory: PageStateHistory\n): RawRumEventCollectedData<RawRumViewEvent> {\n  const replayStats = recorderApi.getReplayStats(view.id)\n  const featureFlagContext = featureFlagContexts.findFeatureFlagEvaluations(view.startClocks.relative)\n  const pageStates = pageStateHistory.findAll(view.startClocks.relative, view.duration)\n  const viewEvent: RawRumViewEvent = {\n    _dd: {\n      document_version: view.documentVersion,\n      replay_stats: replayStats,\n      page_states: pageStates,\n      configuration: {\n        start_session_replay_recording_manually: configuration.startSessionReplayRecordingManually,\n      },\n    },\n    date: view.startClocks.timeStamp,\n    type: RumEventType.VIEW,\n    view: {\n      action: {\n        count: view.eventCounts.actionCount,\n      },\n      frustration: {\n        count: view.eventCounts.frustrationCount,\n      },\n      cumulative_layout_shift: view.commonViewMetrics.cumulativeLayoutShift?.value,\n      cumulative_layout_shift_target_selector: view.commonViewMetrics.cumulativeLayoutShift?.targetSelector,\n      first_byte: toServerDuration(view.initialViewMetrics.navigationTimings?.firstByte),\n      dom_complete: toServerDuration(view.initialViewMetrics.navigationTimings?.domComplete),\n      dom_content_loaded: toServerDuration(view.initialViewMetrics.navigationTimings?.domContentLoaded),\n      dom_interactive: toServerDuration(view.initialViewMetrics.navigationTimings?.domInteractive),\n      error: {\n        count: view.eventCounts.errorCount,\n      },\n      first_contentful_paint: toServerDuration(view.initialViewMetrics.firstContentfulPaint),\n      first_input_delay: toServerDuration(view.initialViewMetrics.firstInput?.delay),\n      first_input_time: toServerDuration(view.initialViewMetrics.firstInput?.time),\n      first_input_target_selector: view.initialViewMetrics.firstInput?.targetSelector,\n      interaction_to_next_paint: toServerDuration(view.commonViewMetrics.interactionToNextPaint?.value),\n      interaction_to_next_paint_target_selector: view.commonViewMetrics.interactionToNextPaint?.targetSelector,\n      is_active: view.isActive,\n      name: view.name,\n      largest_contentful_paint: toServerDuration(view.initialViewMetrics.largestContentfulPaint?.value),\n      largest_contentful_paint_target_selector: view.initialViewMetrics.largestContentfulPaint?.targetSelector,\n      load_event: toServerDuration(view.initialViewMetrics.navigationTimings?.loadEvent),\n      loading_time: discardNegativeDuration(toServerDuration(view.commonViewMetrics.loadingTime)),\n      loading_type: view.loadingType,\n      long_task: {\n        count: view.eventCounts.longTaskCount,\n      },\n      resource: {\n        count: view.eventCounts.resourceCount,\n      },\n      time_spent: toServerDuration(view.duration),\n    },\n    feature_flags: featureFlagContext && !isEmptyObject(featureFlagContext) ? featureFlagContext : undefined,\n    display: view.commonViewMetrics.scroll\n      ? {\n          scroll: {\n            max_depth: view.commonViewMetrics.scroll.maxDepth,\n            max_depth_scroll_top: view.commonViewMetrics.scroll.maxDepthScrollTop,\n            max_scroll_height: view.commonViewMetrics.scroll.maxScrollHeight,\n            max_scroll_height_time: toServerDuration(view.commonViewMetrics.scroll.maxScrollHeightTime),\n          },\n        }\n      : undefined,\n    session: {\n      has_replay: replayStats ? true : undefined,\n      is_active: view.sessionIsActive ? undefined : false,\n    },\n    privacy: {\n      replay_level: configuration.defaultPrivacyLevel,\n    },\n  }\n  if (!isEmptyObject(view.customTimings)) {\n    viewEvent.view.custom_timings = mapValues(\n      view.customTimings,\n      toServerDuration as (duration: Duration) => ServerDuration\n    )\n  }\n  return {\n    rawRumEvent: viewEvent,\n    startTime: view.startClocks.relative,\n    domainContext: {\n      location: view.location,\n    },\n  }\n}\n\nfunction discardNegativeDuration(duration: ServerDuration | undefined): ServerDuration | undefined {\n  return isNumber(duration) && duration < 0 ? undefined : duration\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}